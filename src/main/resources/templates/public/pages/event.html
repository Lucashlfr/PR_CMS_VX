<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="de">
<head th:insert="~{public/fragments/publicFragments :: html_head}"></head>
<body>
<div id="layoutDefault">
    <div id="layoutDefault_content">
        <main>
            <!-- Navbar-->
            <div th:insert="~{public/fragments/publicFragments :: navbar}"></div>
            <!-- Page Header-->
            <section class="bg-light py-10">
                <div class="container px-5">
                    <div class="row gx-5 justify-content-center">
                        <div class="col-lg-10 col-xl-8">
                            <div class="single-post">
                                <h1 th:text="${event.getTitle()}"></h1>
                                <p class="lead" th:text="'Anmeldung'"></p>
                                <img class="img-fluid mb-2 rounded" th:src="${event.getImgUrl()}" />
                                <div class="single-post-text my-5">
                                    <div th:utext="${event.getApplication()}"></div>
                                    <hr class="my-5" />
                                    <div class="card">
                                        <div class="card-header">Anmeldeformular</div>
                                        <div class="card-body">
                                            <form id="dynamicForm" enctype="multipart/form-data">

                                                <input type="text" class="d-none" readonly name="id" th:value="${event.getEventId()}"/>

                                                <div th:each="component : ${components}">
                                                    <div class="row mb-3 align-items-center">
                                                        <label th:for="${component.name}" class="col-sm-2 col-form-label"
                                                               th:text="${component.label}"></label>
                                                        <div class="col-sm-10" th:switch="${component.type.toString()}">

                                                            <div th:case="'TEXT'">
                                                                <input type="text" class="form-control" th:id="${component.name}"
                                                                       th:name="${component.name}" th:value="${component.value}"
                                                                       th:required="${component.required}"/>
                                                            </div>

                                                            <div th:case="'TEXTAREA'">
                                    <textarea class="form-control" th:id="${component.name}" th:name="${component.name}"
                                              th:text="${component.value}"
                                              th:required="${component.required}"></textarea>
                                                            </div>

                                                            <div th:case="'SELECT'">
                                                                <select class="form-select" th:id="${component.name}" th:name="${component.name}"
                                                                        th:required="${component.required}">
                                                                    <option th:each="opt : ${component.options}" th:value="${opt}"
                                                                            th:text="${opt}"></option>
                                                                </select>
                                                            </div>

                                                            <div th:case="'CHECKBOX'">
                                                                <div th:each="opt : ${component.options}">
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox"
                                                                               th:id="${component.name + '_' + opt}" th:name="${component.name}"
                                                                               th:value="${opt}" th:required="${component.required}"/>
                                                                        <label class="form-check-label" th:for="${component.name + '_' + opt}"
                                                                               th:text="${opt}"></label>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div th:case="'RADIO'">
                                                                <div th:each="opt : ${component.options}">
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="radio"
                                                                               th:id="${component.name + '_' + opt}" th:name="${component.name}"
                                                                               th:value="${opt}" th:required="${component.required}"/>
                                                                        <label class="form-check-label" th:for="${component.name + '_' + opt}"
                                                                               th:text="${opt}"></label>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div th:case="'FILE'">
                                                                <input type="file" class="form-control" th:name="${component.name}"
                                                                       th:id="${component.name}" th:required="${component.required}"/>
                                                            </div>

                                                            <!-- Weitere Eingabetypen -->
                                                            <div th:case="'EMAIL'"><input type="email" class="form-control"
                                                                                          th:name="${component.name}"
                                                                                          th:value="${component.value}"/></div>
                                                            <div th:case="'DATE'"><input type="date" class="form-control"
                                                                                         th:name="${component.name}" th:value="${component.value}"/>
                                                            </div>
                                                            <div th:case="'TIME'"><input type="time" class="form-control"
                                                                                         th:name="${component.name}" th:value="${component.value}"/>
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="text-end">
                                                    <button type="button" class="btn btn-primary" onclick="submitForm()">Speichern</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <hr class="my-5" />

                                    <div class="text-center"><a class="btn btn-transparent-dark" href="/">Zurück zur Startseite</a></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div th:insert="~{public/fragments/publicFragments :: footer}"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="js/scripts.js"></script>
</body>
</html>

<script>
    function submitForm() {
        const form = document.getElementById("dynamicForm");
        const formData = new FormData(form);
        let valid = true;
        let missingFields = [];

        // Alle Pflichtfelder prüfen
        form.querySelectorAll("[name]").forEach(el => {
            const isRequired = el.hasAttribute("required");
            const type = el.getAttribute("type");

            // Datei-Upload prüfen
            if (isRequired && type === "file") {
                if (!el.files || el.files.length === 0) {
                    valid = false;
                    missingFields.push(el.name);
                    markInvalid(el);
                } else {
                    clearInvalid(el);
                }
            }

            // Text, Email, Select, etc.
            else if (isRequired && !el.value.trim()) {
                valid = false;
                missingFields.push(el.name);
                markInvalid(el);
            } else {
                clearInvalid(el);
            }
        });

        if (!valid) {
            return;
        }

        // Wenn alles OK, dann absenden
        fetch("/event/application/save", {
            method: "POST",
            body: formData
        }).then(response => response.json())
            .then(data => {
                if (data.redirectUrl) {
                    window.location.href = data.redirectUrl;
                }
            }).catch(error => {
            console.error("Fehler beim Upload:", error);
            alert("Fehler beim Hochladen!");
        });

    }

    function markInvalid(el) {
        el.classList.add("is-invalid");
    }

    function clearInvalid(el) {
        el.classList.remove("is-invalid");
    }
</script>
